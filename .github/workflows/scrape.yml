name: Jobindex Company Scraper

on:
  workflow_dispatch:
    inputs:
      max_companies:
        description: 'Maximum number of companies to scrape (leave empty for all)'
        required: false
        default: ''
      region:
        description: 'Region to scrape'
        required: false
        default: 'storkoebenhavn'
        type: choice
        options:
          - storkoebenhavn
          - nordjylland
          - midtjylland
          - syddanmark
          - sjaelland
  
  schedule:
    - cron: '0 8 * * 1'

jobs:
  scrape:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run scraper
      run: |
        if [ -z "${{ github.event.inputs.max_companies }}" ]; then
          python jobindex_scraper.py --all --region ${{ github.event.inputs.region || 'storkoebenhavn' }} --output companies_${{ github.event.inputs.region || 'storkoebenhavn' }}.csv
        else
          python jobindex_scraper.py --max ${{ github.event.inputs.max_companies }} --region ${{ github.event.inputs.region || 'storkoebenhavn' }} --output companies_${{ github.event.inputs.region || 'storkoebenhavn' }}.csv
        fi
    
    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: company-data-${{ github.event.inputs.region || 'storkoebenhavn' }}-${{ github.run_number }}
        path: companies_*.csv
        retention-days: 90
    
    - name: Display summary
      run: |
        echo "## Scraping Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Region:** ${{ github.event.inputs.region || 'storkoebenhavn' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Run number:** ${{ github.run_number }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ -f companies_*.csv ]; then
          LINES=$(wc -l < companies_*.csv)
          COMPANIES=$((LINES - 1))
          echo "**Companies scraped:** $COMPANIES" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ CSV file generated successfully!" >> $GITHUB_STEP_SUMMARY
        else
          echo "❌ No CSV file generated" >> $GITHUB_STEP_SUMMARY
        fi
